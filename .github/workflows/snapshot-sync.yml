name: Snapshot Sync to IPFS

on:
  schedule:
    - cron: '5 4 * * *'  # Runs daily at 4:05 AM Gulf time
  workflow_dispatch:

jobs:
  export-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Export snapshot JSON
        run: |
          mkdir -p export
          cp config.js export/snapshot_930187.js

      - name: Upload to IPFS via web3.storage
        id: upload
        env:
          WEB3_STORAGE_TOKEN: ${{ secrets.WEB3_STORAGE_TOKEN }}
        run: |
          npm install -g web3.storage
          CID=$(web3.storage put export/snapshot_930187.js --token=$WEB3_STORAGE_TOKEN | tail -n 1)
          echo "cid=$CID" >> $GITHUB_OUTPUT

      - name: Show CID
        run: echo "Snapshot uploaded with CID: ${{ steps.upload.outputs.cid }}"

